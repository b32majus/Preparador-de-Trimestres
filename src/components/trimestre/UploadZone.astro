---
interface Props {
  trimestreId: string;
  section?: 'ingresos' | 'gastos' | 'banco' | 'otros';
}

const { trimestreId, section = 'otros' } = Astro.props;
---

<div class="upload-zone-container">
  <h3 class="upload-title">Subida rápida</h3>

  <div
    class="dropzone"
    data-trimestre-id={trimestreId}
    data-section={section}
  >
    <input type="file" id="file-input-{trimestreId}" multiple hidden />
    <input type="file" id="camera-input-{trimestreId}" accept="image/*" capture="environment" hidden />

    <label for="file-input-{trimestreId}" class="drop-label">
      <span class="upload-icon material-symbols-outlined">cloud_upload</span>
      <p class="primary-text">Arrastra archivos aquí</p>
      <p class="secondary-text">o haz clic para buscar</p>
    </label>

    <button class="camera-btn" type="button" data-camera-btn={trimestreId}>
      <span class="material-symbols-outlined">photo_camera</span>
      <span>Usar cámara</span>
    </button>
  </div>

  <!-- Preview Zone -->
  <div class="preview-zone" style="display: none;" data-preview-zone={trimestreId}>
    <h4 class="preview-title">Archivos seleccionados:</h4>
    <ul class="file-list" id="file-preview-list-{trimestreId}"></ul>
  </div>

  <!-- Recurring Controls -->
  <div class="recurring-controls" style="display: none;" data-recurring-controls={trimestreId}>
    <label class="checkbox-label">
      <input
        type="checkbox"
        id="is-recurring-{trimestreId}"
        class="recurring-checkbox"
        data-recurring-check={trimestreId}
      />
      <span>Marcar como recurrente</span>
    </label>

    <div class="concept-input-wrapper" style="display: none;" data-concept-wrapper={trimestreId}>
      <label for="concept-label-{trimestreId}">Nombre del concepto:</label>
      <input
        type="text"
        id="concept-label-{trimestreId}"
        class="concept-input"
        data-concept-input={trimestreId}
        placeholder="Ej: Alquiler oficina, Seguro empresa..."
      />
    </div>
  </div>

  <!-- Upload Progress -->
  <div class="upload-progress" style="display: none;" data-progress-zone={trimestreId}>
    <div class="progress-fill"></div>
    <p class="progress-text">Subiendo...</p>
  </div>

  <!-- Upload Button -->
  <button class="btn-upload" type="button" disabled data-upload-btn={trimestreId}>
    <span>Subir documentos</span>
    <span class="material-symbols-outlined">upload</span>
  </button>
</div>

<script>
  import { uploadDocument } from '../../lib/supabase.js';

  const trimestreId = document.querySelector('[data-trimestre-id]')?.dataset.trimestreId;
  if (!trimestreId) return;

  // DOM Elements
  const dropzone = document.querySelector(`[data-trimestre-id="${trimestreId}"]`);
  const fileInput = document.getElementById(`file-input-${trimestreId}`);
  const cameraInput = document.getElementById(`camera-input-${trimestreId}`);
  const cameraBtn = document.querySelector(`[data-camera-btn="${trimestreId}"]`);
  const previewZone = document.querySelector(`[data-preview-zone="${trimestreId}"]`);
  const filePreviewList = document.getElementById(`file-preview-list-${trimestreId}`);
  const recurringControls = document.querySelector(`[data-recurring-controls="${trimestreId}"]`);
  const recurringCheckbox = document.querySelector(`[data-recurring-check="${trimestreId}"]`);
  const conceptWrapper = document.querySelector(`[data-concept-wrapper="${trimestreId}"]`);
  const conceptInput = document.querySelector(`[data-concept-input="${trimestreId}"]`);
  const uploadBtn = document.querySelector(`[data-upload-btn="${trimestreId}"]`);
  const progressZone = document.querySelector(`[data-progress-zone="${trimestreId}"]`);
  const progressFill = progressZone.querySelector('.progress-fill');

  // State
  let selectedFiles = [];
  let isRecurring = false;
  let conceptLabel = '';

  // Drag & Drop handlers
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, unhighlight, false);
  });

  function highlight(e) {
    dropzone.classList.add('drag-over');
  }

  function unhighlight(e) {
    dropzone.classList.remove('drag-over');
  }

  dropzone.addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFilesSelected(files);
  }

  // File input change
  fileInput.addEventListener('change', (e) => {
    handleFilesSelected(e.target.files);
  });

  // Camera button
  cameraBtn.addEventListener('click', () => {
    cameraInput.click();
  });

  cameraInput.addEventListener('change', (e) => {
    handleFilesSelected(e.target.files);
  });

  // Handle files selection
  function handleFilesSelected(fileList) {
    selectedFiles = Array.from(fileList);

    if (selectedFiles.length === 0) {
      previewZone.style.display = 'none';
      recurringControls.style.display = 'none';
      uploadBtn.disabled = true;
      return;
    }

    // Show preview
    renderPreview();
    previewZone.style.display = 'block';
    recurringControls.style.display = 'block';
    uploadBtn.disabled = false;
  }

  function renderPreview() {
    filePreviewList.innerHTML = selectedFiles
      .map((file, index) => {
        const fileSize = formatFileSize(file.size);
        return `
          <li class="preview-item" data-file-index="${index}">
            <span class="file-icon material-symbols-outlined">${getFileIcon(file.type)}</span>
            <div class="file-info">
              <p class="file-name">${escapeHtml(file.name)}</p>
              <p class="file-size">${fileSize}</p>
            </div>
            <button type="button" class="remove-btn" data-remove-index="${index}">
              <span class="material-symbols-outlined">close</span>
            </button>
          </li>
        `;
      })
      .join('');

    // Add remove listeners
    filePreviewList.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const index = parseInt(btn.dataset.removeIndex);
        selectedFiles.splice(index, 1);
        if (selectedFiles.length === 0) {
          previewZone.style.display = 'none';
          recurringControls.style.display = 'none';
          uploadBtn.disabled = true;
          fileInput.value = '';
          cameraInput.value = '';
        } else {
          renderPreview();
        }
      });
    });
  }

  // Recurring checkbox toggle
  recurringCheckbox.addEventListener('change', () => {
    isRecurring = recurringCheckbox.checked;
    conceptWrapper.style.display = isRecurring ? 'block' : 'none';
    if (!isRecurring) {
      conceptInput.value = '';
      conceptLabel = '';
    }
  });

  // Concept input change
  conceptInput.addEventListener('input', (e) => {
    conceptLabel = e.target.value.trim();
  });

  // Upload button handler
  uploadBtn.addEventListener('click', uploadFiles);

  async function uploadFiles() {
    if (selectedFiles.length === 0) return;

    uploadBtn.disabled = true;
    progressZone.style.display = 'block';

    const section = dropzone.dataset.section;
    let uploadedCount = 0;
    const totalFiles = selectedFiles.length;

    for (const file of selectedFiles) {
      try {
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          console.error(`File ${file.name} exceeds 10MB limit`);
          alert(`${file.name} exceeds 10MB limit`);
          continue;
        }

        const { data, error } = await uploadDocument(
          file,
          trimestreId,
          section,
          isRecurring,
          isRecurring ? conceptLabel : null
        );

        if (error) {
          console.error(`Error uploading ${file.name}:`, error);
          alert(`Error al subir ${file.name}`);
        } else {
          uploadedCount++;
          const progressPercent = Math.round((uploadedCount / totalFiles) * 100);
          progressFill.style.width = `${progressPercent}%`;

          // Trigger document list refresh
          window.dispatchEvent(new CustomEvent('documentUploaded', {
            detail: { document: data, section }
          }));
        }
      } catch (error) {
        console.error(`Unexpected error uploading ${file.name}:`, error);
      }
    }

    // Hide progress after delay
    setTimeout(() => {
      progressZone.style.display = 'none';
      progressFill.style.width = '0%';

      // Reset form
      selectedFiles = [];
      isRecurring = false;
      conceptLabel = '';
      fileInput.value = '';
      cameraInput.value = '';
      previewZone.style.display = 'none';
      recurringControls.style.display = 'none';
      recurringCheckbox.checked = false;
      conceptInput.value = '';
      conceptWrapper.style.display = 'none';
      uploadBtn.disabled = true;
    }, 1000);
  }

  // Helper functions
  function getFileIcon(mimeType) {
    if (mimeType.includes('pdf')) return 'picture_as_pdf';
    if (mimeType.includes('image')) return 'image';
    if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return 'table_chart';
    return 'description';
  }

  function formatFileSize(bytes) {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

<style>
  .upload-zone-container {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    padding: 1.5rem;
    border: 1px solid white;
  }

  .upload-title {
    font-family: var(--font-serif);
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--text-main);
    margin: 0 0 1rem 0;
  }

  .dropzone {
    border: 2px dashed rgba(184, 137, 125, 0.3);
    background: rgba(184, 137, 125, 0.05);
    border-radius: var(--radius-xl);
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-base);
    position: relative;
  }

  .dropzone:hover {
    background: rgba(184, 137, 125, 0.1);
    border-color: var(--color-primary);
  }

  .dropzone.drag-over {
    background: rgba(184, 137, 125, 0.15);
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(184, 137, 125, 0.1);
  }

  .drop-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
  }

  .upload-icon {
    font-size: 2.5rem;
    color: var(--color-primary);
    transition: transform var(--transition-base);
  }

  .dropzone:hover .upload-icon,
  .dropzone.drag-over .upload-icon {
    transform: scale(1.1);
  }

  .primary-text {
    font-weight: 600;
    color: var(--text-main);
    margin: 0;
    font-size: var(--font-size-base);
  }

  .secondary-text {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    margin: 0;
  }

  .camera-btn {
    display: none;
    align-items: center;
    gap: 0.5rem;
    background: transparent;
    border: 1px solid var(--border-soft);
    color: var(--text-secondary);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    margin-top: 1rem;
    cursor: pointer;
    transition: all var(--transition-base);
    font-size: var(--font-size-sm);
  }

  .camera-btn:hover {
    background: var(--bg-page);
    color: var(--color-primary);
  }

  /* Preview Zone */
  .preview-zone {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-soft);
  }

  .preview-title {
    font-family: var(--font-serif);
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--text-main);
    margin: 0 0 1rem 0;
  }

  .file-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .preview-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--bg-page);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-soft);
  }

  .file-icon {
    font-size: 1.25rem;
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .file-info {
    flex: 1;
    min-width: 0;
  }

  .file-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-main);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-size {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    margin: 0.25rem 0 0 0;
  }

  .remove-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
  }

  .remove-btn:hover {
    color: #EF4444;
  }

  /* Recurring Controls */
  .recurring-controls {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-soft);
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    user-select: none;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
  }

  .checkbox-label:hover {
    background: var(--bg-page);
  }

  .recurring-checkbox {
    width: 1rem;
    height: 1rem;
    border: 2px solid var(--border-soft);
    border-radius: 0.375rem;
    background: white;
    cursor: pointer;
    accent-color: var(--color-primary);
    transition: all var(--transition-base);
  }

  .checkbox-label span {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    transition: color var(--transition-base);
  }

  .checkbox-label:hover span {
    color: var(--text-main);
  }

  .concept-input-wrapper {
    margin-top: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .concept-input-wrapper label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-main);
  }

  .concept-input {
    padding: 0.5rem;
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-md);
    background: white;
    font-family: var(--font-sans);
    font-size: var(--font-size-sm);
    color: var(--text-main);
    transition: all var(--transition-base);
  }

  .concept-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(184, 137, 125, 0.1);
  }

  /* Upload Progress */
  .upload-progress {
    margin-top: 1rem;
  }

  .progress-fill {
    width: 0%;
    height: 3px;
    background: var(--color-primary);
    border-radius: 9999px;
    transition: width var(--transition-base);
    margin-bottom: 0.5rem;
  }

  .progress-text {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    margin: 0;
    text-align: center;
  }

  /* Upload Button */
  .btn-upload {
    width: 100%;
    margin-top: 1.5rem;
    background: var(--color-primary);
    color: white;
    font-weight: 600;
    font-size: var(--font-size-base);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    border: none;
    box-shadow: 0 4px 12px -4px rgba(184, 137, 125, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .btn-upload:hover:not(:disabled) {
    background: var(--color-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px -4px rgba(184, 137, 125, 0.4);
  }

  .btn-upload:active:not(:disabled) {
    transform: translateY(0);
  }

  .btn-upload:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-upload .material-symbols-outlined {
    font-size: 1.25rem;
    transition: transform var(--transition-base);
  }

  .btn-upload:hover:not(:disabled) .material-symbols-outlined {
    transform: translateY(-2px);
  }

  /* Mobile - Camera button visible */
  @media (max-width: 768px) {
    .camera-btn {
      display: flex;
    }

    .upload-zone-container {
      padding: 1rem;
    }

    .dropzone {
      padding: 1.5rem;
    }

    .upload-icon {
      font-size: 2rem;
    }
  }
</style>
