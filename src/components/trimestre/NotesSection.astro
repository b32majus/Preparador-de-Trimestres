---
interface Props {
  notes: Array<{
    id: string;
    content: string;
    for_advisor: boolean;
  }>;
  trimestreId: string;
}

const { notes, trimestreId } = Astro.props;

// Get the most recent note if any
const latestNote = notes && notes.length > 0 ? notes[0] : null;
---

<section class="notes-section">
  <label for={`notes-textarea-${trimestreId}`} class="notes-label">
    Notas del trimestre
  </label>

  <textarea
    id={`notes-textarea-${trimestreId}`}
    class="notes-textarea"
    placeholder="Escribe aquÃ­ cualquier duda o comentario sobre este trimestre..."
    rows="4"
    data-trimestre-id={trimestreId}
  >{latestNote?.content || ''}</textarea>

  <div class="checkbox-wrapper">
    <label class="checkbox-label">
      <input
        type="checkbox"
        id={`for-advisor-${trimestreId}`}
        class="advisor-checkbox"
        checked={latestNote?.for_advisor || false}
        data-trimestre-id={trimestreId}
      />
      <span>Marcar como mensaje importante para mi asesor</span>
    </label>
  </div>
</section>

<script>
  import { saveNote } from '../../lib/supabase.js';

  const trimestreId = document.querySelector('[data-trimestre-id]')?.dataset.trimestreId;

  if (!trimestreId) return;

  const textarea = document.querySelector(`#notes-textarea-${trimestreId}`);
  const checkbox = document.querySelector(`#for-advisor-${trimestreId}`);

  if (!textarea) return;

  let saveTimeout;
  let lastSavedContent = textarea.value;
  let lastSavedForAdvisor = checkbox?.checked || false;

  // Auto-save on input (debounced)
  textarea.addEventListener('input', () => {
    clearTimeout(saveTimeout);

    saveTimeout = setTimeout(async () => {
      const content = textarea.value;
      const forAdvisor = checkbox?.checked || false;

      // Only save if content or checkbox changed
      if (content !== lastSavedContent || forAdvisor !== lastSavedForAdvisor) {
        if (content.trim()) {
          try {
            const { data, error } = await saveNote(trimestreId, content, forAdvisor);

            if (error) {
              console.error('Error saving note:', error);
              // Don't alert on error, just log
            } else {
              lastSavedContent = content;
              lastSavedForAdvisor = forAdvisor;

              // Visual feedback
              textarea.classList.add('saved');
              setTimeout(() => {
                textarea.classList.remove('saved');
              }, 1500);
            }
          } catch (error) {
            console.error('Unexpected error saving note:', error);
          }
        } else {
          // Clear last saved if content is empty
          lastSavedContent = '';
        }
      }
    }, 1000); // 1 second debounce
  });

  // Save on checkbox change
  checkbox?.addEventListener('change', async () => {
    const content = textarea.value;
    const forAdvisor = checkbox.checked;

    if (content.trim()) {
      try {
        const { error } = await saveNote(trimestreId, content, forAdvisor);

        if (error) {
          console.error('Error saving note:', error);
        } else {
          lastSavedForAdvisor = forAdvisor;

          // Visual feedback
          checkbox.parentElement.classList.add('saved');
          setTimeout(() => {
            checkbox.parentElement.classList.remove('saved');
          }, 1500);
        }
      } catch (error) {
        console.error('Unexpected error saving note:', error);
      }
    }
  });
</script>

<style>
  .notes-section {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    padding: 2rem;
    border: 1px solid white;
  }

  .notes-label {
    display: block;
    font-family: var(--font-serif);
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 0.75rem;
  }

  .notes-textarea {
    width: 100%;
    padding: 1rem;
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-xl);
    background: #FAFAFA;
    font-family: var(--font-sans);
    font-size: var(--font-size-sm);
    color: var(--text-main);
    resize: vertical;
    min-height: 7rem;
    transition: all var(--transition-base);
  }

  .notes-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(184, 137, 125, 0.1);
    background: white;
  }

  .notes-textarea.saved {
    border-color: var(--color-success);
    background: rgba(74, 124, 89, 0.05);
  }

  .checkbox-wrapper {
    margin-top: 1rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    user-select: none;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
  }

  .checkbox-label:hover {
    background: var(--bg-page);
  }

  .advisor-checkbox {
    width: 1rem;
    height: 1rem;
    border: 2px solid var(--border-soft);
    border-radius: 0.375rem;
    background: white;
    cursor: pointer;
    accent-color: var(--color-primary);
    transition: all var(--transition-base);
  }

  .advisor-checkbox:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
  }

  .advisor-checkbox:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(184, 137, 125, 0.1);
  }

  .checkbox-label span {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    transition: color var(--transition-base);
  }

  .checkbox-label:hover span {
    color: var(--text-main);
  }

  .checkbox-label.saved span {
    color: var(--color-success);
  }

  @media (max-width: 640px) {
    .notes-section {
      padding: 1.5rem;
    }

    .notes-label {
      font-size: var(--font-size-lg);
    }

    .notes-textarea {
      min-height: 6rem;
    }
  }
</style>
