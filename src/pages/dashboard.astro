---
import App from '../layouts/App.astro';

const baseUrl = import.meta.env.BASE_URL;
---

<App title="Dashboard - Preparador de Trimestres">
  <div id="loading-dashboard" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando tu dashboard...</p>
  </div>

  <div id="dashboard-content" class="dashboard-container" style="display: none;">
    <!-- Contextual Message -->
    <div id="contextual-message"></div>

    <!-- Active Trimestre Card -->
    <div id="active-trimestre"></div>

    <!-- Past Trimestres -->
    <div id="past-trimestres"></div>
  </div>
</App>

<div id="dashboard-config" data-base-url={baseUrl}></div>

<script>
  import { supabase } from '../lib/supabase.js';
  import { getCurrentYearQuarter, getCurrentDayOfMonth, getQuarterDateRange } from '../lib/date-utils.js';
  import { getContextualMessage } from '../lib/microcopy.js';

  const configElement = document.getElementById('dashboard-config');
  const baseUrl = configElement.dataset.baseUrl;

  async function loadDashboard() {
    try {
      console.log('[Dashboard] Starting to load dashboard...');

      // Get current user
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      console.log('[Dashboard] User:', user);

      if (userError || !user) {
        console.error('[Dashboard] No user found, redirecting to login');
        window.location.href = `${baseUrl}login`;
        return;
      }

      // Get current year/quarter
      const { year: currentYear, quarter: currentQuarter } = getCurrentYearQuarter();
      console.log('[Dashboard] Current period:', { year: currentYear, quarter: currentQuarter });

      // Create or get active trimestre
      let trimestreData;
      console.log('[Dashboard] Calling create_trimestre_with_checklist RPC...');
      const { data: activeTrimestre, error: activeError } = await supabase.rpc(
        'create_trimestre_with_checklist',
        {
          p_user_id: user.id,
          p_year: currentYear,
          p_quarter: currentQuarter
        }
      );

      console.log('[Dashboard] RPC response:', { data: activeTrimestre, error: activeError });

      if (activeError) {
        if (activeError.code === '23505') {
          // Already exists, fetch it
          console.log('[Dashboard] Trimestre already exists, fetching...');
          const { data, error: fetchError } = await supabase
            .from('trimestres')
            .select('*, expected_documents(id, status)')
            .eq('user_id', user.id)
            .eq('year', currentYear)
            .eq('quarter', currentQuarter)
            .single();

          if (fetchError) {
            console.error('[Dashboard] Error fetching existing trimestre:', fetchError);
            throw fetchError;
          }

          trimestreData = data;
          console.log('[Dashboard] Fetched existing trimestre:', trimestreData);
        } else {
          console.error('[Dashboard] RPC error (not duplicate):', activeError);
          throw activeError;
        }
      } else {
        trimestreData = activeTrimestre;
        console.log('[Dashboard] Created new trimestre:', trimestreData);
      }

      // Count pending expenses
      const pendingExpenses = trimestreData?.expected_documents?.filter(
        doc => doc.status === 'pending'
      ).length || 0;
      console.log('[Dashboard] Pending expenses:', pendingExpenses);

      // Get past trimestres
      const { data: pastTrimestres, error: pastError } = await supabase
        .from('trimestres')
        .select('id, year, quarter, status, closed_at, checklist_progress')
        .eq('user_id', user.id)
        .neq('id', trimestreData?.id || '')
        .order('year', { ascending: false })
        .order('quarter', { ascending: false })
        .limit(5);

      if (pastError) {
        console.error('[Dashboard] Error fetching past trimestres:', pastError);
      } else {
        console.log('[Dashboard] Past trimestres:', pastTrimestres);
      }

      // Render the dashboard
      console.log('[Dashboard] Rendering dashboard...');
      renderDashboard(trimestreData, pendingExpenses, pastTrimestres || []);

    } catch (error) {
      console.error('[Dashboard] Fatal error:', error);

      // Hide loading, show error
      const loadingDashboard = document.getElementById('loading-dashboard');
      const dashboardContent = document.getElementById('dashboard-content');
      if (loadingDashboard) loadingDashboard.style.display = 'none';

      // Show error message
      alert('Error al cargar el dashboard: ' + (error.message || 'Error desconocido') + '\n\nRevisa la consola para más detalles.');
    }
  }

  function renderDashboard(activeTrimestre, pendingExpenses, pastTrimestres) {
    // Render contextual message
    const dayOfMonth = getCurrentDayOfMonth();
    const progress = activeTrimestre?.checklist_progress || 0;
    const message = getContextualMessage(progress, dayOfMonth);

    const contextualMessageEl = document.getElementById('contextual-message');
    if (contextualMessageEl) {
      contextualMessageEl.innerHTML = `
        <div class="contextual-message">
          <span class="icon material-symbols-outlined">${message.icon}</span>
          <div class="content">
            <h3 class="title">${message.title}</h3>
            <p class="message">${message.message}</p>
          </div>
        </div>
      `;
    }

    // Render active trimestre card
    const activeTrimestreEl = document.getElementById('active-trimestre');
    if (activeTrimestre && activeTrimestreEl) {
      const quarterLabel = `Q${activeTrimestre.quarter}`;
      const quarterDates = getQuarterDateRange(activeTrimestre.quarter);

      activeTrimestreEl.innerHTML = `
        <div class="trimestre-card active">
          <div class="card-header">
            <span class="badge badge-primary">EN CURSO</span>
          </div>

          <h1 class="trimestre-title">${quarterLabel} / ${activeTrimestre.year}</h1>
          <p class="trimestre-dates">${quarterDates}</p>

          <div class="card-content">
            <div class="progress-container">
              <div class="progress-header">
                <span class="progress-label">Progreso general</span>
                <span class="progress-percentage">${progress}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
            </div>

            ${pendingExpenses > 0 ? `
              <div class="expected-badge">
                <span class="icon material-symbols-outlined">folder_open</span>
                <span>${pendingExpenses} ${pendingExpenses === 1 ? 'gasto esperado' : 'gastos esperados'}</span>
              </div>
            ` : ''}

            <a href="${baseUrl}trimestre?id=${activeTrimestre.id}" class="btn-primary">
              <span>Continuar cierre</span>
              <span class="icon-arrow">→</span>
            </a>
          </div>
        </div>
      `;
    }

    // Render past trimestres
    const pastTrimestresEl = document.getElementById('past-trimestres');
    if (pastTrimestres && pastTrimestres.length > 0 && pastTrimestresEl) {
      const pastHTML = pastTrimestres.map(t => {
        const quarterLabel = `Q${t.quarter}`;
        const quarterDates = getQuarterDateRange(t.quarter);
        const closedDate = t.closed_at ? new Date(t.closed_at).toLocaleDateString('es-ES', {
          year: 'numeric',
          month: 'long'
        }) : null;

        return `
          <div class="trimestre-card past">
            <h1 class="trimestre-title">${quarterLabel} / ${t.year}</h1>
            <p class="trimestre-dates">${quarterDates}</p>
            <div class="past-info">
              <div class="status-row">
                <span class="badge badge-success">${t.status || 'Cerrado'}</span>
                ${closedDate ? `<span class="past-date">${closedDate}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      pastTrimestresEl.innerHTML = `
        <section class="past-trimestres">
          <h2 class="past-title">Trimestres anteriores</h2>
          <div class="past-list">
            ${pastHTML}
          </div>
        </section>
      `;
    }

    // Show content, hide loading
    const loadingDashboard = document.getElementById('loading-dashboard');
    const dashboardContent = document.getElementById('dashboard-content');
    if (loadingDashboard) loadingDashboard.style.display = 'none';
    if (dashboardContent) dashboardContent.style.display = 'flex';
  }

  loadDashboard();
</script>

<style is:global>
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: var(--spacing-md);
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(184, 137, 125, 0.2);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-container p {
    color: var(--text-secondary);
    font-size: var(--font-size-base);
  }

  .dashboard-container {
    max-width: 600px;
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2xl);
  }

  /* Contextual Message */
  .contextual-message {
    background: var(--bg-page);
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    gap: var(--spacing-md);
    align-items: flex-start;
    transition: all var(--transition-base) var(--transition-timing);
  }

  .contextual-message:hover {
    box-shadow: var(--shadow-sm);
  }

  .contextual-message .icon {
    color: var(--color-primary);
    font-size: 1.5rem;
    margin-top: 4px;
    flex-shrink: 0;
  }

  .contextual-message .content {
    flex: 1;
  }

  .contextual-message .title {
    font-family: var(--font-serif);
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: var(--spacing-xs);
    line-height: 1.25;
  }

  .contextual-message .message {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    line-height: 1.5;
    margin: 0;
  }

  /* Trimestre Card */
  .trimestre-card {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-soft);
    padding: var(--spacing-2xl);
    position: relative;
    overflow: hidden;
    transition: box-shadow var(--transition-base) var(--transition-timing);
  }

  .trimestre-card.active {
    box-shadow: 0 10px 40px -10px rgba(184, 137, 125, 0.15);
  }

  .trimestre-card.past {
    box-shadow: 0 2px 8px -2px rgba(184, 137, 125, 0.08);
  }

  .trimestre-card.active::before {
    content: '';
    position: absolute;
    top: -64px;
    right: -64px;
    width: 256px;
    height: 256px;
    background: rgba(184, 137, 125, 0.05);
    border-radius: 50%;
    filter: blur(60px);
    pointer-events: none;
  }

  .card-header {
    margin-bottom: var(--spacing-lg);
  }

  .badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: var(--radius-md);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .badge-primary {
    background: rgba(184, 137, 125, 0.1);
    color: var(--color-primary);
  }

  .badge-success {
    background: rgba(74, 124, 89, 0.1);
    color: var(--color-success);
  }

  .trimestre-title {
    font-family: var(--font-serif);
    font-size: 48px;
    font-weight: 700;
    color: var(--text-main);
    text-align: center;
    margin-bottom: var(--spacing-xs);
    position: relative;
    z-index: 1;
  }

  .trimestre-dates {
    text-align: center;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xl);
    position: relative;
    z-index: 1;
  }

  .card-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    position: relative;
    z-index: 1;
  }

  /* Progress Bar */
  .progress-container {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .progress-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: 500;
  }

  .progress-percentage {
    font-size: var(--font-size-sm);
    color: var(--text-main);
    font-weight: 600;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-page);
    border-radius: var(--radius-full);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width var(--transition-base);
    border-radius: var(--radius-full);
  }

  /* Expected Badge */
  .expected-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background-color: var(--color-neutral-100);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    border-left: 4px solid var(--color-primary);
  }

  .expected-badge .icon {
    color: var(--color-primary);
    font-size: 20px;
  }

  /* Button */
  .btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: 14px 28px;
    background: var(--color-primary);
    color: white;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: var(--font-size-base);
    text-decoration: none;
    transition: all var(--transition-base) var(--transition-timing);
    border: none;
    cursor: pointer;
  }

  .btn-primary:hover {
    background: var(--color-primary-hover);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .icon-arrow {
    font-size: 1.25rem;
  }

  /* Past Trimestres */
  .past-trimestres {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .past-title {
    font-family: var(--font-serif);
    font-size: var(--font-size-xl);
    color: var(--text-main);
    font-weight: 600;
    margin: 0;
  }

  .past-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .past-info {
    position: relative;
    z-index: 1;
  }

  .status-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
  }

  .past-date {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
  }

  @media (max-width: 640px) {
    .dashboard-container {
      padding: var(--spacing-lg) var(--spacing-md);
      gap: var(--spacing-xl);
    }

    .trimestre-card {
      padding: var(--spacing-xl) var(--spacing-lg);
    }

    .trimestre-title {
      font-size: 36px;
    }

    .card-header {
      margin-bottom: var(--spacing-md);
    }

    .btn-primary {
      width: 100%;
      padding: 12px 24px;
    }

    .past-title {
      font-size: var(--font-size-lg);
    }

    .contextual-message {
      padding: var(--spacing-md);
      gap: var(--spacing-sm);
    }

    .contextual-message .icon {
      font-size: 1.25rem;
    }

    .contextual-message .title {
      font-size: var(--font-size-base);
    }

    .contextual-message .message {
      font-size: 0.8125rem;
    }
  }
</style>
