---
import Landing from '../layouts/Landing.astro';

// Obtener parámetro de redirección y error desde URL
const baseUrl = import.meta.env.BASE_URL;
const redirectTo = Astro.url.searchParams.get('redirect') || `${baseUrl}dashboard`;
const errorMessage = Astro.url.searchParams.get('error');
---

<Landing title="Iniciar Sesión - Preparador de Trimestres">
  <main class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1>Iniciar Sesión</h1>
        <p class="text-muted">
          Introduce tu correo electrónico y te enviaremos un enlace mágico para acceder.
        </p>
      </div>

      <form id="login-form" class="login-form">
        <div class="form-group">
          <label for="email">Correo electrónico</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            autocomplete="email"
            placeholder="tu@email.com"
          />
        </div>

        <button type="submit" id="submit-btn" class="btn btn-primary btn-block">
          <span id="btn-text">Enviar enlace mágico</span>
          <span id="btn-loading" class="loading-spinner" style="display: none;">
            Enviando...
          </span>
        </button>
      </form>

      <div id="success-message" class="alert alert-success" style="display: none;">
        <p>
          ¡Enlace enviado! Revisa tu correo electrónico y haz clic en el enlace para iniciar sesión.
        </p>
      </div>

      <div id="error-message" class="alert alert-error" style="display: none;">
        <p id="error-text"></p>
      </div>

      {errorMessage && (
        <div class="alert alert-error">
          <p>{errorMessage}</p>
        </div>
      )}
    </div>
  </main>
</Landing>

<div id="auth-config" data-base-url={baseUrl} data-redirect-to={redirectTo}></div>

<script>
  import { supabase } from '../lib/supabase.js';

  const configElement = document.getElementById('auth-config');
  const baseUrl = configElement.dataset.baseUrl;
  const redirectTo = configElement.dataset.redirectTo;

  // Get site URL from environment or fallback to localhost for dev
  const siteUrl = import.meta.env.PUBLIC_SITE_URL || window.location.origin;
  const redirectUrl = `${siteUrl}${baseUrl}auth/callback`;

  // Check if user is already logged in
  async function checkExistingSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      window.location.href = `${baseUrl}dashboard`;
    }
  }

  checkExistingSession();

  const form = document.getElementById('login-form');
  const emailInput = document.getElementById('email');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');
  const errorText = document.getElementById('error-text');

  // Check for error messages in URL on load
  const urlParams = new URLSearchParams(window.location.search);
  const errorParam = urlParams.get('error');

  if (errorParam) {
    showError(decodeURIComponent(errorParam));
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Ocultar mensajes previos
    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';

    // Obtener valor del email
    const email = emailInput.value.trim();

    if (!email) {
      showError('Por favor, introduce un correo electrónico válido.');
      return;
    }

    // Mostrar estado de carga
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';

    try {
      // Enviar Magic Link con URL absoluta
      const emailRedirectTo = `${redirectUrl}?redirect=${encodeURIComponent(redirectTo)}`;

      console.log('Sending magic link with redirect URL:', emailRedirectTo);

      const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: {
          emailRedirectTo: emailRedirectTo
        }
      });

      if (error) {
        throw error;
      }

      // Mostrar mensaje de éxito
      successMessage.style.display = 'block';
      form.style.display = 'none';

    } catch (error) {
      console.error('Login error details:', {
        message: error.message,
        error: error,
        status: error.status,
        code: error.code,
        attemptedRedirectUrl: `${redirectUrl}?redirect=${encodeURIComponent(redirectTo)}`
      });
      showError(error.message || 'Error al enviar el enlace. Inténtalo de nuevo.');
    } finally {
      // Restaurar estado del botón
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  });

  function showError(message) {
    errorText.textContent = message;
    errorMessage.style.display = 'block';
  }
</script>

<style>
  .login-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: var(--spacing-lg);
    background-color: var(--color-neutral-50);
  }

  .login-card {
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: var(--spacing-2xl);
    width: 100%;
    max-width: 420px;
  }

  .login-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
  }

  .login-header h1 {
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-2xl);
  }

  .login-header p {
    margin: 0;
  }

  .login-form {
    margin-bottom: var(--spacing-lg);
  }

  .form-group {
    margin-bottom: var(--spacing-lg);
  }

  .form-group label {
    display: block;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
  }

  .form-group input {
    width: 100%;
    padding: var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    transition: border-color var(--transition-base) var(--transition-timing);
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .btn {
    font-weight: var(--font-weight-medium);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    transition: all var(--transition-base) var(--transition-timing);
    font-size: var(--font-size-base);
  }

  .btn-primary {
    background-color: var(--color-primary);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background-color: var(--color-primary-dark, #4f46e5);
    box-shadow: var(--shadow-md);
  }

  .btn-block {
    width: 100%;
    display: block;
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .loading-spinner {
    display: inline-block;
  }

  .alert {
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-top: var(--spacing-md);
    border: 1px solid;
  }

  .alert p {
    margin: 0;
    font-size: var(--font-size-sm);
  }

  .alert-success {
    background-color: #d1fae5;
    color: #065f46;
    border-color: #6ee7b7;
  }

  .alert-error {
    background-color: #fee2e2;
    color: #991b1b;
    border-color: #fca5a5;
  }

  @media (max-width: 640px) {
    .login-container {
      padding: var(--spacing-md);
    }

    .login-card {
      padding: var(--spacing-lg);
    }
  }
</style>
