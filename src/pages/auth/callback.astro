---
// Página estática que hace el exchange en cliente
const baseUrl = import.meta.env.BASE_URL;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Autenticando...</title>
    <style>
      body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: #FAF8F5;
      }
      .loading-container {
        text-align: center;
      }
      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid rgba(184, 137, 125, 0.2);
        border-top-color: #B8897D;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      p {
        color: #6B635D;
        font-size: 1rem;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Autenticando, por favor espera...</p>
    </div>
  </body>
</html>

<div id="callback-config" 
  data-base-url={baseUrl}
  data-supabase-url={import.meta.env.PUBLIC_SUPABASE_URL}
  data-supabase-key={import.meta.env.PUBLIC_SUPABASE_ANON_KEY}
></div>

<script is:inline src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script is:inline>
  const configElement = document.getElementById('callback-config');
  const baseUrl = configElement.dataset.baseUrl;
  const supabaseUrl = configElement.dataset.supabaseUrl;
  const supabaseKey = configElement.dataset.supabaseKey;

  // Initialize Supabase Client from CDN
  if (!window.supabase) {
    console.error('Supabase library not loaded from CDN');
    window.location.href = `${baseUrl}login?error=${encodeURIComponent('Error cargando librerías. Recarga la página.')}`;
  }
  
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

  async function handleCallback() {
    // 1. Check for errors in the hash (Supabase default for implicit flow / errors)
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const error = hashParams.get('error');
    const errorDescription = hashParams.get('error_description');

    if (error) {
      console.error('Auth error from hash:', error, errorDescription);
      window.location.href = `${baseUrl}login?error=${encodeURIComponent(errorDescription || error)}`;
      return;
    }

    // 2. Check for access_token in hash (Implicit Flow) - detected in user screenshot
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');
    const type = hashParams.get('type');

    if (accessToken) {
      console.log('Implicit flow detected with access_token');
      
      // Manually set the session
      const { error } = await supabaseClient.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken || '',
      });

      if (error) {
         console.error('Error setting session manually:', error);
         window.location.href = `${baseUrl}login?error=${encodeURIComponent(error.message)}`;
         return;
      }

      // Session set successfully
      const redirect = new URLSearchParams(window.location.search).get('redirect') || `${baseUrl}dashboard`;
      window.location.href = redirect;
      return;
    }
    
    if (type === 'recovery' || type === 'magiclink') {
       const redirect = new URLSearchParams(window.location.search).get('redirect') || `${baseUrl}dashboard`;
       // Fallback for types without explicit access token in hash immediately visible
       supabaseClient.auth.onAuthStateChange((event, session) => {
          if (event === 'SIGNED_IN' || session) {
            window.location.href = redirect;
          }
       });
       return;
    }

    // 3. Check for code in query params (PKCE flow)
    const queryParams = new URLSearchParams(window.location.search);
    const code = queryParams.get('code');
    const redirect = queryParams.get('redirect') || `${baseUrl}dashboard`;

    if (!code) {
      // If no code, no error, and no access_token check if we have an active session anyway
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        window.location.href = redirect;
        return;
      }

      // No code, no error, no access_token, no session -> Invalid link
      window.location.href = `${baseUrl}login?error=${encodeURIComponent('Enlace de autenticación inválido o expirado')}`;
      return;
    }

    try {
      // 3. Exchange code for session
      const { error: exchangeError } = await supabaseClient.auth.exchangeCodeForSession(code);

      if (exchangeError) {
        console.error('Auth callback error:', exchangeError);
        window.location.href = `${baseUrl}login?error=${encodeURIComponent('Error de autenticación. Inténtalo de nuevo.')}`;
        return;
      }

      // Success - redirect
      window.location.href = redirect;

    } catch (err) {
      console.error('Unexpected auth error:', err);
      window.location.href = `${baseUrl}login?error=${encodeURIComponent('Error inesperado. Inténtalo de nuevo.')}`;
    }
  }

  handleCallback();
</script>
